# 查询语句

```SQL
SELECT COUNT(DISTINCT ud.DEV_CODE)com,uc.user_id from db_vice_customer_device ud
LEFT JOIN db_vice_return_visit r on r.dev_code=ud.dev_code and r.PHONE_STATE='1' and  to_days(now()) - to_days(r.CREATE_TIME)<=3
LEFT JOIN db_vice_bloodpressurexx b  on b.dev_code=ud.dev_code and  to_days(now()) - to_days(b.RECEIVE_TIME)<=3 and b.`LEVEL`=6
LEFT JOIN  db_vice_user_custom uc on ud.customer_id=uc.customer_id
LEFT JOIN db_vice_customer u on u.id=ud.customer_id and u.phone>'' and u.GROUP_CODE!='8'
WHERE r.DEV_CODE is null and b.dev_code>'' and  uc.customer_id>'' and u.id>''
GROUP BY uc.user_id

```

> 执行超过20分钟，仍没有结束


# 检测步骤

1. 检查执行计划
> 发现都很正常
![](assets/004/20170725-fc91c3fb.png)  


2. 检查索引
索引表用到的都有索引

3. Google
查到这样一句话：
![](assets/004/20170725-d9c357d1.png)  


检查所有用到的表的排序规则，发现确实不一样，有的是utf8\_general\_ci、有的是utf8mb4\_general\_ci还有的是latin1\_general\_ci，把所有的都统一成utf8的，然后执行，20秒结束
